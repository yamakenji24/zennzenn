---
title: "Next.js Ã— Recoil Ã— Prismaã§å§‹ã‚ã‚‹Todo App"
emoji: "ğŸ“–"
type: "tech"
topics:
  - "nextjs"
  - "typescript"
  - "tech"
  - "prisma"
  - "recoil"
published: true
published_at: "2022-02-11 09:15"
---

# æ¦‚è¦
æœ¬è¨˜äº‹ã§ã¯ã€Next.js+Recoil+Prismaã‚’ç”¨ã„ã¦ã€ç°¡æ˜“çš„ãªTodo Appã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
ä¸»ã«ã€Recoilã‚’ç”¨ã„ãŸéåŒæœŸå‡¦ç†ã«ã¤ã„ã¦è§¦ã‚Œã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã‚’å‚ç…§ãã ã•ã„ã€‚
https://github.com/yamakenji24/recoil-todo-list


# ç’°å¢ƒæ§‹ç¯‰
æœ¬ç’°å¢ƒã®versionä¸€è¦§
```json:package.json
"next": "^12.0.10",
"react": "^18.0.0-rc.0",
"react-dom": "^18.0.0-rc.0",
"recoil": "^0.6.1"
```

## Next.jsã®æ§‹ç¯‰
Next.jsã‚’æ§‹ç¯‰ã™ã‚‹ã®ã«ã€å‚è€ƒã«ãªã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä»¥ä¸‹ã«è¨˜è¼‰ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚
https://nextjs.org/docs/getting-started
https://zenn.dev/a_da_chi/articles/181ea4ccc39580


## Recoilå°å…¥
ã¾ãšã¯ã€Recoilã‚’å°å…¥ã—ã¦ã„ãã¾ã™ã€‚
npmã‚‚ã—ãã¯yarnã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```
$ npm install recoil
```
Recoilã§çŠ¶æ…‹ç®¡ç†ã™ã‚‹éƒ¨åˆ†ã‚’RecoilRootã§å›²ã¿ã¾ã™ã€‚
```tsx:pages/_app.tsx
import { AppProps } from "next/app";
import { RecoilRoot } from "recoil";
export default function MyApp({ Component, pageProps }: AppProps) {
  return (
    <RecoilRoot>
      <Component {...pageProps} />
    </RecoilRoot>
  );
}
```

## Prismaå°å…¥
prismaã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ã‚¹ã‚­ãƒ¼ãƒã‚’ç”Ÿæˆã—ã¦ã„ãã¾ã™ã€‚
```
$ npm install @prisma/client
$ npm install -D prisma
$ npx prisma init
```
schema.prismaã«prismaã®è¨­å®šã¨ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

```prisma:prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Todo {
  id        Int    @id @default(autoincrement())
  text     String
  completed Boolean @default(false)
}
```

## Dockerã§ã¾ã¨ã‚ã¦ç®¡ç†
ãƒ­ãƒ¼ã‚«ãƒ«ã®ç’°å¢ƒã‚’æ±šã—ãŸããªã„ã®ã§ã€Dockerã§mysqlã¨ã¤ã„ã§ã«Next.jsã‚‚ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ãã¾ã™
```Dockerfile:Dockerfile
FROM node:16.13.1-alpine3.12 AS deps

RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

FROM node:16.13.1-alpine3.12 AS builder
WORKDIR /app
COPY . .
COPY --from=deps /app/node_modules ./node_modules
RUN npm run build:all && npm install --production --ignore-scripts --prefer-offline

FROM node:16.13.1-alpine3.12 AS runner
WORKDIR /app

COPY --from=builder /app/public ./public
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json

EXPOSE 3000

CMD ["node_modules/.bin/next", "start"]
```

```yml:docker-compose.yml
version: "3"

services:
  front:
    container_name: recoil-todo-front
    build: './'
    depends_on:
      - recoil-todo-mysql
    environment:
      - DATABASE_URL=${DATABASE_URL}
    ports:
      - '3000:3000'
    restart: always
  mysql:
    container_name: recoil-todo-mysql
    image: mysql:5.7
    environment:
      MYSQL_DATABASE: prisma
      MYSQL_ROOT_PASSWORD: prisma
    volumes:
      - 'mysql-data:/var/lib/mysql'
    ports:
      - '3306:3306'
    restart: always

volumes:
  mysql-data:
```
ã“ã‚Œã§ã€`docker compose up`ã§ã¾ã¨ã‚ã¦èµ·å‹•ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

# Todoã®çŠ¶æ…‹ç®¡ç†
## TodoListã®èª­ã¿å–ã‚Š
TodoListã®åˆæœŸå€¤ã‚’ã€DBã‹ã‚‰å–å¾—ã—ãŸå€¤ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€atomã®defaultå†…ã§selectorã‚’ç”¨ã„ã¦éåŒæœŸå‡¦ç†ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚
atomã¯çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã„ã‚‹ã¨ã“ã‚ã§ã€Reduxã«ãŠã‘ã‚‹Storeã¿ãŸã„ãªæ„Ÿã˜ã ã¨æ€ã„ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®atomã¯ç›´æ¥exportã›ãšã«ã€èª­ã¿å–ã‚Šå°‚ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œæˆã—ã€å‘¼ã³å‡ºã—ã¦ä½¿ç”¨ã—ã¦ã„ãã¾ã™ã€‚

```ts:./src/todo-state.ts
import { atom, selector, useRecoilValue } from "recoil";
import { fetchTodoListAPI } from "./api";

export interface TodoItem {
  id: number;
  text: string;
  completed: boolean;
}

export const todoListState = atom<TodoItem[]>({
  key: "todoListState",
  default: selector({
    key: "initialTodoListState",
    get: async () => await fetchTodoListAPI(),
  }),
});

const todoListSelector = selector({
  key: "todoListSelector",
  get: ({ get }) => get(todoListState),
});

export const todoSelectors = {
  useGetTodoList: () => useRecoilValue(todoListSelector),
};
```
ãªãŠã€ç¾æ®µéšã§ã¯Next.jsã®SSRã§Suspenseã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã€ä»¥ä¸‹ã®ã©ã‚Œã‹ã®å¯¾å¿œã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
1. Next.jsã®experimentalãªconcurrentFeaturesã®åˆ©ç”¨
2. SSRæ™‚ã«å–å¾—ã—ãªã„
3. Recoilã®useRecoilValueLoadableã‚’ä½¿ç”¨ã™ã‚‹

1.ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€Reactã‚’18ç³»ã«ä¸Šã’ã¦ã€next.config.jsã«è¨­å®šã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
è©³ç´°ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://nextjs.org/docs/advanced-features/react-18
```tsx:src/pages/index.tsx
return (
  <div>
    ...
    <Suspense fallback={<div>Loading...</div>}>
      <TodoList ... />
    </Suspense>
  </div>
)
```
ã“ã“ã®TodoListã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã€å…ˆã»ã©å®Ÿè£…ã—ãŸTodoListã®å–å¾—ã‚’è¡Œã†ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’å‘¼ã³å‡ºã›ã°ã€ç„¡äº‹å–å¾—ãŒã§ãã‚‹ï¼
ã¨æ€ãˆã°ã€ãã‚“ãªã“ã¨ã¯ãªãã€useRecoilValueã‚’ç”¨ã„ã¦atomã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ãã‚‹ã¨ã“ã‚ã§ã€å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ãŠãã‚‰ãã€PromiseãŒã¡ã‚ƒã‚“ã¨è¿”ã›ã¦ã„ãªã„ã®ãŒåŸå› ã‹ãªã¨æ€ã‚ã‚Œã¾ã™ãŒã€ä»Šå›ã¯SSRã—ãªã„æ–¹å¼ã§ã‚„ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚(ã”å­˜çŸ¥ã®æ–¹ã„ã‚Œã°ãœã²æ•™ãˆã¦ãã ã•ã„)
Suspenseã‚ˆã‚Šä¸Šã®éšå±¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’dynamic importã—ã¦SSRã—ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚
```tsx:pages/_app.tsx
export default function MyApp({ Component, pageProps }: AppProps) {
  const NoSSR = dynamic(() => import("src/components/NoSSR"));

  return (
    <NoSSR>
      <RecoilRoot>
        <Component {...pageProps} />
      </RecoilRoot>
    </NoSSR>
  );
}
```

## Todoã®è¿½åŠ å‡¦ç†
atomã«æ–°ã—ã„Todoã‚’è¿½åŠ ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
atomã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ã«ã¯ã€useStateã®ã‚ˆã†ãªsetterã‚’æŒã¤useSetRecoilStateã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯useRecoilCallbackã‚’åˆ©ç”¨ã—ãŸã€actionã®ã‚ˆã†ãªã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€
- çŠ¶æ…‹ã«å¯¾ã™ã‚‹æ“ä½œã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«é–‰ã˜è¾¼ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹
- API Callãªã©éåŒæœŸå‡¦ç†ãŒæ‰±ã„ã‚„ã™ããªã‚‹

ã¨ã„ã£ãŸãƒ¡ãƒªãƒƒãƒˆãŒå¾—ã‚‰ã‚Œã‚‹ã‹ãªã¨æ€ã„ã¾ã™ã€‚
ã¾ãŸã€ç®¡ç†ã™ã‚‹çŠ¶æ…‹ã®æ“ä½œã‚‚è¿½åŠ ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

```ts: src/dispatcher.ts
import { useRecoilCallback } from "recoil";
import { todoListState } from "./todo-state";
import { addTodoAPI } from "./api";

export const useCreateDispatcher = () => {
  const addTodo = useRecoilCallback(({ set }) => async (text: string) => {
    const newTodo = await addTodoAPI(text);
    set(todoListState, (oldTodos) => [...oldTodos, newTodo]);
  }, []);

  return {
    addTodo,
  };
};
```

```ts:src/api.ts
export const addTodoAPI = async (text: string): Promise<TodoItem> => {
  return await fetch("http://localhost:3000/api/todo", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ text }),
  }).then((res) => res.json());
};
```

prismaã®æ“ä½œã¯åŸºæœ¬çš„ã«ã€next.jsã®apiçµŒç”±ã§è¡Œã£ã¦ã„ã¾ã™ã€‚
```ts:src/pages/api/todo
import type { NextApiRequest, NextApiResponse } from "next";
import { prisma } from "src/lib/prisma";

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  switch (req.method) {
    case "GET":
      const todos = await prisma.todo.findMany();
      return res.status(200).json(todos);
    case "POST":
      const todo = await prisma.todo.create({
        data: {
          text: req.body.text,
        },
      });
      return res.status(200).json(todo);
    default:
      return res.send("Method not allowed");
  }
}
```

## Todoã®å‰Šé™¤ã€æ›´æ–°
Todoã®å‰Šé™¤ã¨æ›´æ–°ã‚‚åŒæ§˜ã«è¡Œã£ã¦ã„ãã¾ã™ã€‚
çŠ¶æ…‹ã®æ“ä½œã¯å…¨ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«ã¾ã¨ã‚ã¦ã„ã‚‹ã®ã§ã€è¿½è¨˜ã—ã¦ã„ãã ã‘ã«ãªã‚Šã¾ã™ã€‚
```ts: src/dispatcher.ts
import { useRecoilCallback } from "recoil";
import { todoListState } from "./todo-state";
import { addTodoAPI, deleteTodoAPI, updateTodoAPI } from "./api";

export const useCreateDispatcher = () => {
  const addTodo = useRecoilCallback(
    ...
  );

  const deleteTodo = useRecoilCallback(({ set }) => async (id: number) => {
    await deleteTodoAPI(id);
    set(todoListState, (oldTodos) => 
        oldTodos.filter((todo) => todo.id !== id)
    );
  }, []);

  const updateTodo = useRecoilCallback(({ set }) => 
    async (id: number, text: string) => {
      const updatedTodo = await updateTodoAPI(id, text);
      set(todoListState, (oldTodos) =>
        oldTodos.map((todo) => (todo.id === id ? updatedTodo : todo))
      );
    }, []);
    
  return {
    addTodo,
    deleteTodo,
    updateTodo,
  };
};
```

# ã¾ã¨ã‚
æœ¬è¨˜äº‹ã§ã¯ã€Next.js+Recoil+Prismaã‚’ç”¨ã„ã¦ã€ç°¡æ˜“çš„ãªTodo Appã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã—ãŸã€‚
Recoilã§éåŒæœŸå‡¦ç†ã‚’è¡Œã†ãŸã‚ã«Suspenseã®æŒ¯ã‚Šè¿”ã‚Šãªã©ã€ã„ã‚ã„ã‚èª¿ã¹ã¦ã„ã¦é¢ç™½ã„ãªã¨æ€ã„ã¾ã—ãŸã€‚
å€‹äººçš„ãªæ„Ÿæƒ³ã¨ã—ã¦ã€useStateã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æ‹¡å¼µã—ãŸæ„Ÿã˜ã§ç°¡å˜ã«æ‰±ãˆã‚‹ã®ã§æ¥½ã ã£ãŸãªã¨æ€ã†åé¢ã€éåŒæœŸå‡¦ç†ã®æ‰±ã„ãŒå°‘ã—ã‚ã‚“ã©ãã•ã„ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚
ç‰¹ã«ã€SSRæ™‚ã«éåŒæœŸå‡¦ç†ã‚’è¡Œã†éš›ã«ã€Suspenseã«å¯¾ã™ã‚‹å¯¾å¿œã‚’ã©ã†ã—ã‚ˆã†ã¨æ‚©ã¿ã¾ã—ãŸã€‚
ã¾ã ã¾ã Recoilã¯é–‹ç™ºæ®µéšãªã®ã§ã€ã“ã‚Œã‹ã‚‰ã‚‚è¿½ã£ã¦ã„ããŸã„ãªã¨æ€ã„ã¾ã™ã€‚